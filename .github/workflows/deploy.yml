name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for info only)
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            echo "ðŸš€ Start $(date)"

            APP_DIR=${{ secrets.VPS_APP_PATH }}
            SERVICE=${{ secrets.SERVICE_NAME }}
            PORT=${{ secrets.APP_PORT || 3000 }}
            DOMAIN=${{ secrets.HEALTH_DOMAIN || 'smoothiekingcaters.com' }}

            retry() {  # retry <max> <delay> <cmd...>
              local -r max="$1"; shift
              local -r delay="$1"; shift
              local n=1
              until "$@"; do
                if [ $n -ge "$max" ]; then
                  echo "âŒ Command failed after $n attempts: $*"
                  return 1
                fi
                echo "â³ Attempt $((n+1))/$max in ${delay}s: $*"
                n=$((n+1))
                sleep "$delay"
              done
            }

            echo "ðŸ“‚ Ensure app dir exists: $APP_DIR"
            sudo mkdir -p "$APP_DIR"
            sudo chown -R $USER:$USER "$APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "â¬‡ï¸ Clone repo"
              git clone https://github.com/${{ github.repository }} "$APP_DIR"
            else
              echo "ðŸ”„ Update repo"
              cd "$APP_DIR"
              git fetch --prune origin
              git checkout -B main origin/main
            fi

            echo "ðŸ“¦ Install deps"
            cd "$APP_DIR"
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

            echo "ðŸ—ï¸ Build"
            npm run build

            echo "ðŸ”„ Restart service: $SERVICE"
            sudo systemctl restart "$SERVICE"
            sudo systemctl status "$SERVICE" --no-pager || true

            echo "ðŸ” Reload Nginx"
            sudo systemctl reload nginx

            echo "ðŸ©º Health check (local http://127.0.0.1:$PORT)"
            retry 30 2 curl -fsS "http://127.0.0.1:${PORT}" >/dev/null

            echo "ðŸŒŽ Health check (public https://${DOMAIN})"
            retry 30 2 curl -fsSIL "https://${DOMAIN}" >/dev/null

            echo "âœ… Done $(date)"
